version: '3.6'

services:

# redis standalone - uncomment
#  redis:
#    image: redis:alpine
#    command: redis-server /usr/local/redis.conf
#    configs:
#      - source: redis_config
#        target: /usr/local/redis.conf
#    hostname: redis
#    networks:
#      - backend

#  minio:
#    image: minio/minio:RELEASE.2018-09-12T18-49-56Z
#    volumes:
#      - minio:/data
#    ports:
#      - "9000"
#    command: server /data
#    environment:
#      MINIO_ACCESS_KEY:  minio
#      MINIO_SECRET_KEY:   minio123
#    networks:
#      - backend

#  dscheduler:
#    image: daskdev/dask
#    ports:
#      - '8786:8786'
#      - '8787:8787'
#    command: ['dask-scheduler']
#    networks:
#      - backend

#  dworker:
#    image: daskdev/dask
#    command: ['dask-worker','scheduler:8786']
#    networks:
#      - backend


  g_cabs_creator:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_creator.py cl-gcabs 2016
    restart: on-failure
    networks:
      - backend
    deploy:
      mode: replicated
      replicas: 1

  g_cabs_loader:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_performer.py dl-gcabs
    restart: on-failure
    networks:
      - backend
    depends_on:
      - g_cabs_creator
    deploy:
      mode: replicated
      replicas: 0

  g_cabs_cleaner:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_performer.py cl-gcabs
    restart: on-failure
    networks:
    - backend
    depends_on:
    - g_cabs_creator
    deploy:
      mode: replicated
      replicas: 8

#  y_cabs_creator:
#    build: .
#    image: sirisurab/tp-app:latest
#    container_name: y_cabs_combiner
#    networks:
#      - backend
#    command: ./bin/combiner_ycabs.sh 2016 2017
#    volumes:
#      - tp:/app
#    depends_on:
#      - redis

#  y_cabs_loader:
#    build: .
#    container_name: y_cabs_fetcher
#    networks:
#      - backend
#    command: ./bin/fetcher_ycabs.sh
#    volumes:
#      - tp:/app
#    depends_on:
#      - y_cabs_creator
#    deploy:
#      mode: replicated
#      replicas: 8

  turnstile_creator:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_creator.py rs-transit 2016
    restart: on-failure
    networks:
      - backend
    deploy:
      mode: replicated
      replicas: 0

  turnstile_loader:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_performer.py dl-transit
    restart: on-failure
    networks:
      - backend
    depends_on:
      - turnstile_creator
    deploy:
      mode: replicated
      replicas: 0

  turnstile_cleaner:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_performer.py cl-transit
    restart: on-failure
    networks:
    - backend
    depends_on:
    - turnstile_creator
    deploy:
      mode: replicated
      replicas: 0


  turnstile_resampler:
    build: .
    image: sirisurab/tp-app:latest
    command: ./src/task_performer.py rs-transit
    restart: on-failure
    networks:
      - backend
    depends_on:
      - turnstile_creator
    deploy:
      mode: replicated
      replicas: 0

#  stations_fetcher:
#    build: .
#    image: sirisurab/tp-app:latest
#    container_name: stations_fetcher
#    command: ./bin/stations.sh
#    volumes:
#      - tp:/app

  traffic_creator:
    build: .
    image: sirisurab/tp-app:latest
    restart: on-failure
    networks:
      - backend
    command: ./src/task_creator.py dl-traffic
    depends_on:
      - redis
    deploy:
      mode: replicated
      replicas: 0

  traffic_loader:
    build: .
    image: sirisurab/tp-app:latest
    restart: on-failure
    networks:
      - backend
    command: ./src/task_performer.py dl-traffic
    depends_on:
      - traffic_creator
    deploy:
      mode: replicated
      replicas: 0

#volumes:
#  tp:
#    driver: convoy
#  minio:
#  sirisurab-tp:
#    external: true


#configs:
#  redis_config:
#    file: ./config/redis.conf

networks:
  backend:
    external:
      name: backend
# redis cluster - uncomment
#    external:
# redis standalone - uncomment
#    driver: overlay
#    attachable: true
#    ipam:
#      config:
#        - subnet: 10.0.0.0/24